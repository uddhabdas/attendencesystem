<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - AI Attendance System</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary-gradient: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);
            --secondary-gradient: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            --accent-gradient: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            --success-gradient: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);
            --warning-gradient: linear-gradient(135deg, #f39c12 0%, #f1c40f 100%);
            --danger-gradient: linear-gradient(135deg, #c0392b 0%, #e74c3c 100%);
            
            --card-shadow: 0 10px 30px -5px rgba(0, 0, 0, 0.1);
            --hover-shadow: 0 20px 40px -5px rgba(0, 0, 0, 0.15);
            --text-primary: #2c3e50;
            --text-secondary: #7f8c8d;
            --bg-light: #f8f9fa;
            
            --border-radius: 16px;
            --border-radius-lg: 24px;
            --border-radius-sm: 12px;
            
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            
            --spacing-xs: 0.5rem;
            --spacing-sm: 1rem;
            --spacing-md: 1.5rem;
            --spacing-lg: 2rem;
            --spacing-xl: 3rem;
            
            --font-weight-normal: 400;
            --font-weight-medium: 500;
            --font-weight-semibold: 600;
            --font-weight-bold: 700;
        }
        
        body {
            background-color: var(--bg-light);
            font-family: 'Inter', 'Segoe UI', system-ui, -apple-system, sans-serif;
            color: var(--text-primary);
            line-height: 1.6;
        }
        
        .main-header {
            background: var(--primary-gradient);
            padding: 3rem 2.5rem;
            border-radius: var(--border-radius);
            margin-bottom: 2.5rem;
            text-align: left;
            color: white;
            box-shadow: var(--card-shadow);
            position: relative;
            overflow: hidden;
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .main-header::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0) 70%);
            z-index: 1;
        }
        
        .main-header:hover {
            transform: translateY(-7px);
            box-shadow: 0 20px 40px rgba(102, 126, 234, 0.4);
        }
        
        .main-header h1, .main-header p {
            position: relative;
            z-index: 2;
        }
        
        .main-header h1 {
            margin: 0;
            font-size: 2.8rem;
            font-weight: 700;
            letter-spacing: -0.5px;
            line-height: 1.2;
        }
        
        .profile-btn {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 0.75rem 2rem;
            border-radius: 50px;
            font-weight: 500;
            letter-spacing: 0.5px;
            transition: var(--transition);
            text-transform: uppercase;
            font-size: 0.9rem;
        }

        .profile-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            border-color: rgba(255, 255, 255, 0.4);
            transform: translateY(-2px);
        }

        .main-header p {
            margin: 0.5rem 0 0 0;
            font-size: 1.1rem;
            opacity: 0.9;
        }
        
        .metric-card {
            background: #ffffff;
            padding: 1.5rem;
            border-radius: var(--border-radius);
            box-shadow: var(--card-shadow);
            border: none;
            margin: 1.25rem 0;
            text-align: center;
            transition: var(--transition);
            position: relative;
            overflow: hidden;
        }
        
        .metric-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 15px rgba(0,0,0,0.1);
        }
        
        .metric-card h6 {
            color: #6c757d;
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
        }
        
        .metric-card h3 {
            color: #495057;
            margin: 0;
            font-weight: 700;
        }
        
        .status-card {
            padding: 1.5rem;
            border-radius: var(--border-radius);
            margin: 1rem 0;
            border: none;
            background: #ffffff;
            box-shadow: var(--card-shadow);
            transition: var(--transition);
            position: relative;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .status-card::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            height: 100%;
            width: 6px;
        }
        
        .status-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 25px rgba(0,0,0,0.12);
        }
        
        .status-present {
            background-color: rgba(40, 167, 69, 0.1);
            color: #155724;
        }
        
        .status-present::before {
            background-color: #28a745;
        }
        
        .status-absent {
            background-color: rgba(220, 53, 69, 0.1);
            color: #721c24;
        }
        
        .status-absent::before {
            background-color: #dc3545;
        }
        
        .status-unknown {
            background-color: rgba(255, 193, 7, 0.1);
            color: #856404;
        }
        
        .status-unknown::before {
            background-color: #ffc107;
        }
        
        .camera-container {
            background: #ffffff;
            border: none;
            border-radius: var(--border-radius);
            padding: 1.5rem;
            box-shadow: var(--card-shadow);
            text-align: center;
            position: relative;
            overflow: hidden;
            transition: var(--transition);
            margin: 1.5rem 0;
        }
        
        .camera-container::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 5px;
            background: var(--primary-gradient);
        }
        
        .camera-container:hover {
            transform: translateY(-7px);
            box-shadow: 0 20px 40px rgba(102, 126, 234, 0.3);
        }
        
        .section-header {
            background: var(--secondary-gradient);
            padding: 1.5rem;
            border-radius: var(--border-radius);
            color: white;
            margin: 2rem 0 1.5rem;
            text-align: left;
            box-shadow: var(--card-shadow);
            position: relative;
            overflow: hidden;
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .section-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(45deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0) 100%);
            z-index: 1;
        }
        
        .section-header:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 35px rgba(79, 172, 254, 0.35);
        }
        
        .section-header h3 {
            position: relative;
            z-index: 2;
        }
        
        .section-header h3 {
            margin: 0;
            font-size: 1.6rem;
            font-weight: 600;
            letter-spacing: -0.3px;
            line-height: 1.3;
        }
        
        .attendance-summary {
            background: var(--primary-gradient);
            padding: 1.5rem;
            border-radius: 12px;
            color: white;
            text-align: center;
            margin: 1rem 0;
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.2);
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
        }
        
        .attendance-summary::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0) 100%);
            z-index: 1;
        }
        
        .attendance-summary:hover {
            transform: translateY(-7px);
            box-shadow: 0 20px 40px rgba(102, 126, 234, 0.4);
        }
        
        .attendance-summary h4, .attendance-summary h2, .attendance-summary h3, .attendance-summary p {
            position: relative;
            z-index: 2;
        }
        
        .student-list {
            max-height: 400px;
            overflow-y: auto;
            padding: 1.5rem;
            background: #ffffff;
            border-radius: var(--border-radius);
            border: none;
            box-shadow: var(--card-shadow);
            transition: var(--transition);
            scrollbar-width: thin;
            scrollbar-color: var(--text-secondary) transparent;
        }

        .student-list::-webkit-scrollbar {
            width: 6px;
        }

        .student-list::-webkit-scrollbar-track {
            background: transparent;
        }

        .student-list::-webkit-scrollbar-thumb {
            background-color: var(--text-secondary);
            border-radius: 20px;
        }
        
        .student-list:hover {
            box-shadow: 0 6px 15px rgba(0,0,0,0.06);
        }
        
        .btn {
            border-radius: var(--border-radius) !important;
            font-weight: 600 !important;
            box-shadow: var(--card-shadow) !important;
            transition: var(--transition) !important;
            padding: 0.8rem 1.5rem;
            margin: 0.3rem 0;
            border: none !important;
            position: relative;
            overflow: hidden;
            z-index: 1;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-size: 0.9rem;
        }
        
        .btn::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 0;
            background: rgba(255,255,255,0.1);
            transition: all 0.3s ease;
            z-index: -1;
        }
        
        .btn:hover {
            transform: translateY(-5px) !important;
            box-shadow: 0 12px 25px rgba(0,0,0,0.15) !important;
        }
        
        .btn:hover::after {
            height: 100%;
        }
        
        .btn-primary, .btn-success, .btn-info, .btn-warning, .btn-danger {
            background-image: linear-gradient(135deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0) 100%) !important;
        }
        
        .sidebar {
            background: #ffffff;
            border-right: 1px solid rgba(0,0,0,0.1);
            height: 100vh;
            position: fixed;
            top: 0;
            left: 0;
            padding: 2rem 1.5rem;
            overflow-y: auto;
            width: 280px;
            box-shadow: var(--card-shadow);
            transition: var(--transition);
            z-index: 1000;
        }
        
        .sidebar:hover {
            box-shadow: 3px 0 15px rgba(0,0,0,0.05);
        }
        
        .main-content {
            margin-left: 280px;
            padding: 2rem;
            max-width: 1400px;
            margin-right: auto;
            min-height: 100vh;
            background: var(--bg-light);
        }
        
        .recognition-info {
            background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);
            border: none;
            border-radius: var(--border-radius);
            padding: 1.5rem;
            margin: 1rem 0;
            color: white;
            text-align: left;
            box-shadow: var(--card-shadow);
            position: relative;
            overflow: hidden;
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .recognition-info::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: #28a745;
        }
        
        .recognition-info:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 15px rgba(40, 167, 69, 0.12);
        }
        
        .unknown-info {
            background: linear-gradient(135deg, #f39c12 0%, #f1c40f 100%);
            border: none;
            border-radius: var(--border-radius);
            padding: 1.5rem;
            margin: 1rem 0;
            color: white;
            text-align: left;
            box-shadow: var(--card-shadow);
            position: relative;
            overflow: hidden;
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .unknown-info::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: #ffc107;
        }
        
        .unknown-info:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 15px rgba(255, 193, 7, 0.12);
        }
        
        #videoFeed {
            border-radius: 10px;
            width: 100%;
            background-color: #000;
            max-height: 450px;
            box-shadow: 0 6px 15px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
            transform: scale(0.99);
        }
        
        #videoFeed:hover {
            transform: scale(1);
            box-shadow: 0 8px 20px rgba(0,0,0,0.15);
        }
        
        .form-select {
            border-radius: 6px;
            border: 1px solid rgba(225, 229, 255, 0.5);
            padding: 0.6rem 1rem;
            font-size: 1rem;
            box-shadow: 0 3px 8px rgba(0,0,0,0.02);
            transition: all 0.2s ease;
            background-color: rgba(255, 255, 255, 0.9);
        }
        
        .form-select:focus {
            border-color: #667eea;
            box-shadow: 0 4px 10px rgba(102, 126, 234, 0.1);
            transform: translateY(-1px);
            background-color: #ffffff;
        }
        
        .table th {
            background: #667eea;
            color: white;
            border: none;
            padding: 0.6rem;
            font-size: 0.95rem;
        }
        
        .table-hover tbody tr:hover {
            background-color: rgba(102, 126, 234, 0.05);
        }
        
        .alert {
            border-radius: 6px;
            border: 1px solid rgba(0,0,0,0.05);
            padding: 0.75rem 1rem;
            margin-bottom: 0.75rem;
        }
        
        /* Scrollbar styling */
        .student-list::-webkit-scrollbar {
            width: 6px;
        }
        
        .student-list::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        
        .student-list::-webkit-scrollbar-thumb {
            background: #667eea;
            border-radius: 10px;
        }
        
        .student-list::-webkit-scrollbar-thumb:hover {
            background: #5a67d8;
        }
        
        .camera-placeholder {
            width: 100%;
            height: 480px;
            background-color: #000;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.2rem;
        }

        /* Student Photo Styles */
        .student-photo {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid #667eea;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }

        .student-photo-placeholder {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea, #764ba2);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 18px;
            border: 2px solid #e1e5ff;
        }

        .student-info-cell {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .student-details {
            flex: 1;
        }

        .student-name {
            font-weight: 600;
            color: #333;
            margin: 0;
            font-size: 14px;
        }

        .student-mobile {
            color: #666;
            font-size: 12px;
            margin: 2px 0 0 0;
        }

        .student-sgpa {
            color: #667eea;
            font-size: 11px;
            margin: 2px 0 0 0;
            font-weight: 500;
        }

        /* Section Selection Styles */
        .section-radio-buttons {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            padding: 0.5rem 0;
            min-height: 50px; /* Ensure container has minimum height */
        }

        .section-radio {
            padding: 0.75rem 1rem;
            border-radius: 8px;
            transition: all 0.2s ease;
            border: 1px solid #dee2e6;
            background-color: #f8f9fa;
            display: flex;
            align-items: center;
        }

        .section-radio:hover {
            background-color: #e9ecef;
            transform: translateX(5px);
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .section-radio .form-check-input {
            margin-right: 10px;
            cursor: pointer;
        }

        .section-radio .form-check-input:checked + .form-check-label {
            font-weight: 600;
            color: #667eea;
        }
        
        .section-radio .form-check-input:checked ~ .section-radio {
            border-color: #667eea;
            background-color: #f0f4ff;
        }

        .section-radio .form-check-label {
            width: 100%;
            cursor: pointer;
            font-weight: 500;
            padding-left: 5px;
            display: inline-block;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        #sectionMetrics {
            background: var(--primary-gradient);
            color: white;
            padding: 2rem;
        }

        #sectionMetrics .metric-icon {
            font-size: 2rem;
            margin-bottom: 1rem;
            opacity: 0.9;
        }

        #sectionMetrics h6 {
            color: rgba(255,255,255,0.9);
            font-size: 1rem;
            margin-bottom: 0.5rem;
            font-weight: 500;
        }

        #sectionMetrics h3 {
            color: white;
            font-size: 2.5rem;
            margin: 0;
            font-weight: 700;
        }

        /* Modal for student details */
        .student-detail-modal .modal-content {
            border-radius: 24px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.2);
            border: none;
            overflow: hidden;
        }

        .student-detail-header {
            background: var(--primary-gradient);
            color: white;
            border-radius: 0;
            text-align: center;
            padding: 2.5rem;
            position: relative;
            overflow: hidden;
        }
        
        .student-detail-header::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0) 70%);
            z-index: 1;
        }
        
        .student-detail-header h4, .student-detail-header p {
            position: relative;
            z-index: 2;
        }

        .student-detail-photo {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            object-fit: cover;
            border: 4px solid white;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            margin-bottom: 1rem;
        }

        .student-detail-photo-placeholder {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            background: rgba(255,255,255,0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 48px;
            border: 4px solid white;
            margin-bottom: 1rem;
        }

        .detail-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 0;
            border-bottom: 1px solid #eee;
        }

        .detail-label {
            font-weight: 600;
            color: #555;
        }

        .detail-value {
            color: #333;
            font-weight: 500;
        }

        .sgpa-badge {
            background: var(--secondary-gradient);
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.875rem;
            font-weight: 600;
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .sidebar {
                width: 100%;
                height: auto;
                position: relative;
            }
            
            .main-content {
                margin-left: 0;
            }
            
            .student-info-cell {
                flex-direction: column;
                gap: 10px;
                text-align: center;
            }
        }
    </style>
</head>
<body>
    <div class="sidebar">
        <div class="text-center mb-4">
            <h4 class="text-primary"><i class="bi bi-person-workspace"></i> <span id="sidebarUsername">{{ username }}</span></h4>
            <p class="text-muted">Faculty Dashboard</p>
        </div>
        
        <h5 class="mt-4"><i class="bi bi-gear"></i> System Controls</h5>
        <a href="/logout" class="btn btn-outline-danger w-100 mb-3"><i class="bi bi-box-arrow-right"></i> Logout</a>
        
        <hr>
        
        <h5 class="mt-4"><i class="bi bi-graph-up"></i> Quick Stats</h5>
        <div id="sidebarStats">
            <div class="metric-card">
                <h6>Students Present</h6>
                <h3 id="presentCount">0</h3>
            </div>
            
            <div class="metric-card">
                <h6>Camera FPS</h6>
                <h3 id="cameraFps">0.0</h3>
            </div>
            
            <div class="metric-card">
                <h6>Faces Detected</h6>
                <h3 id="facesDetected">0</h3>
            </div>
        </div>
        
        <hr>
        
        <h5 class="mt-4"><i class="bi bi-info-circle"></i> System Info</h5>
        <div class="alert alert-info" style="background-color: #e8f4f8; border-color: #b8e2ec;">
            <i class="bi bi-calendar"></i> <span id="currentDate"></span>
        </div>
        <div class="alert alert-info" style="background-color: #e8f4f8; border-color: #b8e2ec;">
            <i class="bi bi-clock"></i> <span id="currentTime"></span>
        </div>
        <div class="alert alert-info" style="background-color: #e8f4f8; border-color: #b8e2ec;">
            <i class="bi bi-cpu"></i> <span>AI Attendance System v1.0</span>
        </div>
    </div>
    
    <div class="main-content">
       

        <!-- Main Content Starts Here -->
        
        <!-- Section Selection -->
        <div class="section-header">
            <h3><i class="bi bi-journal-text"></i> Section Selection</h3>
        </div>
        
        <div class="row mb-4">
            <div class="col-md-8">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title mb-3">Select a Section</h5>
                        <div class="section-radio-buttons" id="sectionRadioContainer">
                            <!-- Radio buttons will be added dynamically via JavaScript -->
                            <div class="text-center py-2" id="loadingMessage">
                                <div class="spinner-border spinner-border-sm text-primary" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                                <span class="ms-2">Loading sections...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="metric-card text-center" id="sectionMetrics">
                    <div class="metric-icon">
                        <i class="bi bi-people-fill"></i>
                    </div>
                    <h6>Total Students</h6>
                    <h3 id="totalStudents">0</h3>
                </div>
            </div>
        </div>
        
        <!-- Attendance Controls -->
        <div class="section-header">
            <h3><i class="bi bi-camera-video"></i> Attendance Control Panel</h3>
        </div>
        
        <div class="row mb-4">
            <div class="col-md-3">
                <button class="btn btn-success w-100 mb-2" id="startSession"><i class="bi bi-play-fill"></i> Start Session</button>
            </div>
            <div class="col-md-3">
                <button class="btn btn-danger w-100 mb-2" id="stopSession" disabled><i class="bi bi-stop-fill"></i> Stop Session</button>
            </div>
            <div class="col-md-3">
                <button class="btn btn-warning w-100 mb-2" id="resetData" disabled><i class="bi bi-arrow-repeat"></i> Reset Data</button>
            </div>
            <div class="col-md-3">
                <button class="btn btn-info w-100 mb-2" data-bs-toggle="modal" data-bs-target="#manualEntryModal"><i class="bi bi-pencil-square"></i> Manual Entry</button>
            </div>
        </div>
        
        <!-- Camera Feed Section -->
        <div id="cameraSection" style="display: none;">
            <div class="section-header">
                <h3><i class="bi bi-camera"></i> Live Camera Feed & Face Recognition</h3>
            </div>
            
            <div class="row">
                <div class="col-md-8">
                    <div class="camera-container">
                        <img id="videoFeed" src="{{ url_for('video_feed') }}">
                    </div>
                </div>
                
                <div class="col-md-4">
                    <h4 class="mb-3"><i class="bi bi-bar-chart-line"></i> Live Recognition Status</h4>
                    
                    <div class="row mb-3">
                        <div class="col-6">
                            <div class="metric-card text-center">
                                <h6>FPS</h6>
                                <h3 id="liveFps">0.0</h3>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="metric-card text-center">
                                <h6>Faces</h6>
                                <h3 id="liveFaces">0</h3>
                            </div>
                        </div>
                    </div>
                    
                    <div id="recognitionResults" class="mb-3">
                        <div class="alert alert-info"><i class="bi bi-camera"></i> Scanning for faces...</div>
                    </div>
                    
                    <hr>
                    
                    <h5 class="mb-3"><i class="bi bi-person-check"></i> Present Today</h5>
                    <div class="metric-card text-center mb-3">
                        <h6>Total Present</h6>
                        <h3 id="livePresent">0</h3>
                    </div>
                    
                    <div id="recentRecognitions" class="student-list">
                        <p class="text-muted text-center">No recognitions yet</p>
                    </div>
                    
                    <hr>
                    
                    <div class="row">
                        <div class="col-6">
                            <button class="btn btn-outline-primary w-100" id="refreshStats"><i class="bi bi-graph-up"></i> Stats</button>
                        </div>
                        <div class="col-6">
                            <button class="btn btn-outline-secondary w-100" onclick="location.reload()"><i class="bi bi-arrow-clockwise"></i> Refresh</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Attendance Summary -->
        <div id="attendanceSummary" style="display: none;">
            <div class="section-header">
                <h3><i class="bi bi-clipboard-data"></i> Attendance Summary</h3>
            </div>
            
            <div class="row">
                <div class="col-md-12">
                    <div class="attendance-summary">
                        <h4><i class="bi bi-graph-up-arrow"></i> Attendance Metrics</h4>
                        <h2 id="attendanceRatio">0/0</h2>
                        <h3 id="attendanceRate">0%</h3>
                        <p>Attendance Rate</p>
                    </div>
                    
                    <h5 class="mt-4"><i class="bi bi-check-circle"></i> Present Students</h5>
                    <div id="presentStudentsList" class="student-list">
                        <p class="text-muted text-center">No students marked present yet</p>
                    </div>
                </div>
            </div>
            
            <!-- Detailed Attendance Table -->
            <div class="section-header mt-4">
                <h3><i class="bi bi-list-check"></i> Detailed Attendance Record</h3>
            </div>
            
            <div class="table-responsive">
                <table class="table table-striped table-hover" id="attendanceTable">
                    <thead class="table-dark">
                        <tr>
                            <th>S.No</th>
                            <th>Student Details</th>
                            <th>Roll Number</th>
                            <th>Status</th>
                            <th>Section</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Will be populated by JavaScript -->
                    </tbody>
                </table>
            </div>
            
            <!-- Manual Attendance Marking Interface -->
            <div class="section-header">
                <h3><i class="bi bi-pencil"></i> Manual Attendance Marking</h3>
            </div>
            
            <div class="row mb-4">
                <div class="col-md-12">
                    <div class="card">
                        <div class="card-body">
                            <div class="d-flex justify-content-between mb-3">
                                <div>
                                    <button class="btn btn-success btn-sm" id="markAllPresent">Mark All Present</button>
                                    <button class="btn btn-danger btn-sm ms-2" id="markAllAbsent">Mark All Absent</button>
                                </div>
                                <div>
                                    <button class="btn btn-primary btn-sm" id="saveAttendance">Save Attendance</button>
                                </div>
                            </div>
                            <div class="table-responsive">
                                <table class="table table-hover" id="attendanceMarkingTable">
                                    <thead>
                                        <tr>
                                            <th>Roll No</th>
                                            <th>Name</th>
                                            <th>Status</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <!-- Students will be loaded here dynamically -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Export Section -->
            <div class="section-header">
                <h3><i class="bi bi-box-arrow-up"></i> Export & Reports</h3>
            </div>
            
            <div class="row">
                <div class="col-md-4">
                    <a href="#" class="btn btn-primary w-100 mb-2" id="exportExcel"><i class="bi bi-file-earmark-excel"></i> Generate Excel Report</a>
                </div>
                <div class="col-md-4">
                    <a href="#" class="btn btn-success w-100 mb-2" id="exportCSV"><i class="bi bi-file-earmark-text"></i> Generate CSV Report</a>
                </div>
                <div class="col-md-4">
                    <button class="btn btn-info w-100 mb-2" disabled><i class="bi bi-envelope"></i> Email Report</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Manual Entry Modal -->
    <div class="modal fade" id="manualEntryModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-pencil-square"></i> Manual Attendance Entry</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="manualSectionSelect" class="form-label">Select Section</label>
                            <select class="form-select" id="manualSectionSelect">
                                <option value="">Choose a section...</option>
                                <!-- Will be populated dynamically -->
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="manualStudentSelect" class="form-label">Select Student</label>
                            <select class="form-select" id="manualStudentSelect">
                                <option value="">Select a student...</option>
                                <!-- Will be populated based on section -->
                            </select>
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-12">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h5 class="mb-0">Student List</h5>
                                <div>
                                    <button class="btn btn-success btn-sm" id="manualMarkAllPresent">Mark All Present</button>
                                    <button class="btn btn-danger btn-sm ms-2" id="manualMarkAllAbsent">Mark All Absent</button>
                                </div>
                            </div>
                            <div class="table-responsive">
                                <table class="table table-hover" id="manualAttendanceTable">
                                    <thead>
                                        <tr>
                                            <th>Roll No</th>
                                            <th>Name</th>
                                            <th>Status</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <!-- Students will be loaded here dynamically -->
                                        <tr>
                                            <td colspan="4" class="text-center">Please select a section first</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="manualSaveAttendance">Save Attendance</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Student Details Modal -->
    <div class="modal fade student-detail-modal" id="studentDetailsModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="student-detail-header">
                    <div id="studentPhotoContainer"></div>
                    <h4 id="modalStudentName">Student Name</h4>
                    <p id="modalStudentRoll">Roll Number</p>
                </div>
                <div class="modal-body">
                    <div id="studentDetailsContent">
                        <!-- Will be populated by JavaScript -->
                    </div>
                    
                    <!-- Attendance History Section -->
                    <div class="mt-4">
                        <h5 class="mb-3">📊 Attendance History</h5>
                        <div class="table-responsive">
                            <table class="table table-hover" id="studentAttendanceHistory">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Status</th>
                                        <th>Section</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Will be populated by JavaScript -->
                                    <tr>
                                        <td colspan="3" class="text-center">Loading attendance history...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <!-- Daily Attendance Section -->
                    <div class="mt-4">
                        <h5 class="mb-3">📚 Daily Class Attendance</h5>
                        <div class="table-responsive">
                            <table class="table table-hover" id="studentDailyAttendance">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Classes Attended</th>
                                        <th>Total Classes</th>
                                        <th>Subjects</th>
                                        <th>Ratio</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Will be populated by JavaScript -->
                                    <tr>
                                        <td colspan="5" class="text-center">Loading daily attendance...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <!-- Attendance Statistics -->
                    <div class="row mt-4">
                        <div class="col-md-6">
                            <div class="metric-card">
                                <h6>Overall Attendance Rate</h6>
                                <div class="progress mt-2" style="height: 25px;" id="studentAttendanceRate">
                                    <div class="progress-bar bg-success" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
                                        0%
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="metric-card">
                                <h6>Present Days</h6>
                                <h3 id="studentPresentDays">0</h3>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="metric-card">
                                <h6>Absent Days</h6>
                                <h3 id="studentAbsentDays">0</h3>
                            </div>
                        </div>
                    </div>
                    
                    <!-- SGPA Graph Section -->
                    <div class="mt-4">
                        <h5 class="mb-3">📊 SGPA Performance Graph</h5>
                        <div id="sgpaGraphContainer" class="graph-container">
                            <div class="text-center py-4">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                                <p class="mt-2">Loading SGPA graph...</p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.plot.ly/plotly-2.24.1.min.js"></script>
    <script>
        // Global variables
        let currentSection = '';
        let recognitionInterval;
        let statsInterval;
        
        // Define SECTIONS for frontend use
        var SECTIONS = [
            {% for key, value in sections.items() %}
            {
                "id": "{{ key }}",
                "name": "{{ value.name }}",
                "start": {{ value.start }},
                "end": {{ value.end }},
                "prefix": "{{ value.prefix }}",
                "total_students": {{ value.end - value.start + 1 }}
            }{% if not loop.last %},{% endif %}
            {% endfor %}
        ];
        
        // Debug: Log the sections data from server
        console.log('Sections from server:', {{ sections|tojson }});
        console.log('User sections from session:', {{ user_sections|tojson }});
        
        // Add all sections from SECTIONS constant in app.py
        // This is a temporary fix to show all sections
        if (SECTIONS.length <= 4) {
            SECTIONS = [
                { "id": "CSE_DS", "name": "CSE-DS", "start": 1, "end": 60, "prefix": "23CSEDS", "total_students": 60 },
                { "id": "CSEAIML_A", "name": "CSE AIML-A", "start": 0, "end": 64, "prefix": "23CSEAIML", "total_students": 65 },
                { "id": "CSEAIML_B", "name": "CSE AIML-B", "start": 65, "end": 128, "prefix": "23CSEAIML", "total_students": 64 },
                { "id": "CSEAIML_C", "name": "CSE AIML-C", "start": 129, "end": 192, "prefix": "23CSEAIML", "total_students": 64 },
                { "id": "CSE_A", "name": "CSE-A", "start": 1, "end": 60, "prefix": "23CSE", "total_students": 60 },
                { "id": "CSE_B", "name": "CSE-B", "start": 61, "end": 120, "prefix": "23CSE", "total_students": 60 },
                { "id": "CSE_C", "name": "CSE-C", "start": 121, "end": 180, "prefix": "23CSE", "total_students": 60 },
                { "id": "CSE_D", "name": "CSE-D", "start": 181, "end": 240, "prefix": "23CSE", "total_students": 60 }
            ];
            console.log('Updated SECTIONS array with all sections:', SECTIONS);
        }

        // Helper function to get student image URL
        function getStudentImageUrl(rollNumber) {
            return `https://gietuerp.in/StudentDocuments/${rollNumber}/${rollNumber}.JPG`;
        }

        // Helper function to get student initials
        function getStudentInitials(name) {
            return name.split(' ').map(word => word.charAt(0)).join('').substring(0, 2).toUpperCase();
        }

        // Helper function to create student photo element
        function createStudentPhotoElement(rollNumber, name, size = 50) {
            const photoUrl = getStudentImageUrl(rollNumber);
            const initials = getStudentInitials(name);
            
            return `
                <img src="${photoUrl}" 
                     alt="${name}" 
                     class="student-photo" 
                     style="width: ${size}px; height: ${size}px;"
                     onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                <div class="student-photo-placeholder" 
                     style="width: ${size}px; height: ${size}px; display: none; font-size: ${size/3}px;">
                    ${initials}
                </div>
            `;
        }

        // Function to show student details modal
        function showStudentDetails(rollNumber) {
    console.log('Fetching student details for:', rollNumber);
    fetch(`/api/student/${rollNumber}`)
        .then(response => {
            console.log('Response status:', response.status);
            if (!response.ok) {
                throw new Error(`HTTP error! Status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            console.log('Received data:', data);
            if (!data || !data.success) {
                console.error('Error fetching student data:', data);
                alert('Error fetching student details. Please try again.');
                return;
            }
            
            const student = data.student;
            if (!student) {
                throw new Error('Student data is missing in the response');
            }
            // Update modal header
            document.getElementById('modalStudentName').textContent = student.name;
            document.getElementById('modalStudentRoll').textContent = student.rollNo || rollNumber;
            
            // Update photo
            const photoContainer = document.getElementById('studentPhotoContainer');
            const photoUrl = student.image_url || getStudentImageUrl(rollNumber);
            const initials = getStudentInitials(student.name);
            
            photoContainer.innerHTML = `
                <img src="${photoUrl}" 
                     alt="${student.name}" 
                     class="student-detail-photo"
                     onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                <div class="student-detail-photo-placeholder" style="display: none;">
                    ${initials}
                </div>
            `;
            
            // Calculate CGPA
            let cgpa = student.cgpa || 0;
            if (!cgpa) {
                let totalSGPA = 0;
                let semesterCount = 0;
                
                if (student.sgpas) {
                    for (const semester in student.sgpas) {
                        if (student.sgpas[semester]) {
                            totalSGPA += parseFloat(student.sgpas[semester]);
                            semesterCount++;
                        }
                    }
                    
                    if (semesterCount > 0) {
                        cgpa = (totalSGPA / semesterCount).toFixed(2);
                    }
                }
            }
            
            // Create SGPA graph data
            let sgpaHTML = '';
            if (student.sgpas) {
                for (const semester in student.sgpas) {
                    if (student.sgpas[semester]) {
                        const sgpa = parseFloat(student.sgpas[semester]);
                        const color = sgpa >= 8.5 ? '#28a745' : sgpa >= 7.5 ? '#17a2b8' : '#ffc107';
                        
                        sgpaHTML += `
                        <div class="detail-row">
                            <span class="detail-label">SGPA Semester ${semester}:</span>
                            <span class="detail-value">
                                <span class="sgpa-badge" style="background-color: ${color}">${sgpa}</span>
                            </span>
                        </div>
                        `;
                    }
                }
            }
            
            // Update details
            const detailsContent = document.getElementById('studentDetailsContent');
            detailsContent.innerHTML = `
                <div class="detail-row">
                    <span class="detail-label">Roll Number:</span>
                    <span class="detail-value">${student.rollNo || rollNumber}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Name:</span>
                    <span class="detail-value">${student.name}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Mobile:</span>
                    <span class="detail-value">${student.mobile}</span>
                </div>
            `;
            
            // Add SGPA and other details to the content
            detailsContent.innerHTML += `
                ${sgpaHTML}
                <div class="detail-row">
                    <span class="detail-label">CGPA:</span>
                    <span class="detail-value">
                        <span class="sgpa-badge" style="background-color: #007bff">${cgpa}</span>
                    </span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Section:</span>
                    <span class="detail-value">${SECTIONS[currentSection]?.name || 'N/A'}</span>
                </div>
                <div id="sgpaChart" style="width:100%; height:300px; margin-top:20px; border-radius:16px; overflow:hidden; box-shadow: 0 10px 25px rgba(0,0,0,0.08); background-color: #f8f9ff;"></div>
            `;
            
            // Show modal
            const modal = new bootstrap.Modal(document.getElementById('studentDetailsModal'));
            modal.show();
            
            // Populate attendance history table
            const attendanceHistoryTable = document.getElementById('studentAttendanceHistory').querySelector('tbody');
            if (student.attendance_history && student.attendance_history.length > 0) {
                let tableContent = '';
                let presentCount = 0;
                let totalClasses = student.attendance_history.length;
                
                student.attendance_history.forEach(record => {
                    const date = new Date(record.date).toLocaleDateString();
                    const status = record.status;
                    const statusClass = status === 'Present' ? 'text-success' : 'text-danger';
                    const statusIcon = status === 'Present' ? '✅' : '❌';
                    
                    if (status === 'Present') presentCount++;
                    
                    tableContent += `
                        <tr>
                            <td>${date}</td>
                            <td class="${statusClass}">${statusIcon} ${status}</td>
                            <td>${record.section || 'N/A'}</td>
                        </tr>
                    `;
                });
                
                attendanceHistoryTable.innerHTML = tableContent;
                
                // Use attendance percentage from API if available, otherwise calculate from history
                let attendanceRate = student.attendance_percentage || (presentCount / totalClasses) * 100;
                const formattedRate = attendanceRate.toFixed(1);
                
                // Update progress bar
                const progressBar = document.getElementById('studentAttendanceRate').querySelector('.progress-bar');
                progressBar.style.width = `${formattedRate}%`;
                progressBar.setAttribute('aria-valuenow', formattedRate);
                progressBar.textContent = `${formattedRate}%`;
                
                // Set color based on attendance rate
                if (attendanceRate >= 75) {
                    progressBar.className = 'progress-bar bg-success';
                } else if (attendanceRate >= 60) {
                    progressBar.className = 'progress-bar bg-warning';
                } else {
                    progressBar.className = 'progress-bar bg-danger';
                }
                
                // Update present and absent counts
                document.getElementById('studentPresentDays').textContent = presentCount;
                document.getElementById('studentAbsentDays').textContent = totalClasses - presentCount;
                
                // Populate daily attendance table
                const dailyAttendanceTable = document.getElementById('studentDailyAttendance').querySelector('tbody');
                if (student.daily_attendance && student.daily_attendance.length > 0) {
                    let tableContent = '';
                    
                    student.daily_attendance.forEach(record => {
                        const date = new Date(record.date).toLocaleDateString();
                        const attended = record.classes_attended;
                        const total = record.total_classes;
                        const ratio = `${attended}/${total}`;
                        const percentage = (attended / total) * 100;
                        
                        // Determine color based on attendance ratio
                        let badgeClass = 'bg-danger';
                        if (percentage >= 75) {
                            badgeClass = 'bg-success';
                        } else if (percentage >= 60) {
                            badgeClass = 'bg-warning';
                        }
                        
                        // Generate subject icons
                        let subjectIcons = '';
                        if (record.subjects && record.subjects.length > 0) {
                            record.subjects.forEach(subject => {
                                const icon = subject.attended ? '✅' : '❌';
                                subjectIcons += `<span title="${subject.name}" class="badge ${subject.attended ? 'bg-success' : 'bg-danger'} me-1">${subject.name.substring(0, 3)} ${icon}</span>`;
                            });
                        } else {
                            subjectIcons = '<span class="text-muted">No subject data</span>';
                        }
                        
                        tableContent += `
                            <tr>
                                <td>${date} (${record.day})</td>
                                <td>${attended}</td>
                                <td>${total}</td>
                                <td>${subjectIcons}</td>
                                <td>
                                    <span class="badge ${badgeClass}">${ratio}</span>
                                </td>
                            </tr>
                        `;
                    });
                    
                    dailyAttendanceTable.innerHTML = tableContent;
                } else {
                    dailyAttendanceTable.innerHTML = `
                        <tr>
                            <td colspan="5" class="text-center">No daily attendance records found</td>
                        </tr>
                    `;
                }
            } else {
                attendanceHistoryTable.innerHTML = `
                    <tr>
                        <td colspan="3" class="text-center">No attendance records found</td>
                    </tr>
                `;
                
                // Reset statistics
                document.getElementById('studentAttendanceRate').querySelector('.progress-bar').style.width = '0%';
                document.getElementById('studentAttendanceRate').querySelector('.progress-bar').textContent = '0%';
                document.getElementById('studentPresentDays').textContent = '0';
                document.getElementById('studentAbsentDays').textContent = '0';
            }
            
            // Display SGPA graph if available
            const sgpaGraphContainer = document.getElementById('sgpaGraphContainer');
            if (student.sgpa_graph) {
                sgpaGraphContainer.innerHTML = student.sgpa_graph;
            } else if (semesterCount > 0) {
                // Fallback if server-side graph is not available
                sgpaGraphContainer.innerHTML = '<div class="alert alert-info">SGPA graph could not be loaded. Please check if Plotly is installed on the server.</div>';
                
                // Create a simple representation of SGPA data
                let sgpaHtml = '<div class="table-responsive mt-3"><table class="table table-sm table-bordered"><thead><tr><th>Semester</th><th>SGPA</th></tr></thead><tbody>';
                
                for (const semester in student.sgpas) {
                    if (student.sgpas[semester]) {
                        const sgpa = parseFloat(student.sgpas[semester]);
                        let badgeClass = 'bg-danger';
                        
                        if (sgpa >= 8.5) {
                            badgeClass = 'bg-success';
                        } else if (sgpa >= 7.5) {
                            badgeClass = 'bg-info';
                        } else if (sgpa >= 6.5) {
                            badgeClass = 'bg-warning';
                        }
                        
                        sgpaHtml += `
                            <tr>
                                <td>Semester ${semester}</td>
                                <td><span class="badge ${badgeClass}">${sgpa.toFixed(2)}</span></td>
                            </tr>
                        `;
                    }
                }
                
                sgpaHtml += `
                    <tr class="table-active">
                        <td><strong>CGPA</strong></td>
                        <td><strong>${student.cgpa.toFixed(2)}</strong></td>
                    </tr>
                </tbody></table></div>`;
                
                sgpaGraphContainer.innerHTML += sgpaHtml;
            } else {
                 sgpaGraphContainer.innerHTML = '<div class="alert alert-warning">No SGPA data available for this student.</div>';
              }
            }
        })
        .catch(error => {
            console.error('Error fetching student details:', error);
            alert('Error fetching student details');
        });
}

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            updateDateTime();
            setInterval(updateDateTime, 1000);
            
            loadSections();
            setupEventListeners();
            
            // Start polling for recognition status if session is active
            checkSessionStatus();
        });
        
        function updateDateTime() {
            const now = new Date();
            document.getElementById('currentDate').textContent = now.toLocaleDateString('en-US', { 
                year: 'numeric', month: 'long', day: 'numeric' 
            });
            document.getElementById('currentTime').textContent = now.toLocaleTimeString('en-US');
        }
        
        function loadSections() {
            // SECTIONS is already an array, so we can use it directly
            const sectionsArray = SECTIONS;
            
            // Debug: Log the sections array to console
            console.log('SECTIONS array:', sectionsArray);
            console.log('Number of sections:', sectionsArray.length);
            
            // Use the SECTIONS array to create radio buttons
            const radioContainer = document.getElementById('sectionRadioContainer');
            radioContainer.innerHTML = ''; // Clear loading message
            
            // Hide loading message
            const loadingMessage = document.getElementById('loadingMessage');
            if (loadingMessage) {
                loadingMessage.style.display = 'none';
            }
            
            sectionsArray.forEach(section => {
                const radioDiv = document.createElement('div');
                radioDiv.className = 'form-check section-radio mb-2';
                
                const radioInput = document.createElement('input');
                radioInput.className = 'form-check-input';
                radioInput.type = 'radio';
                radioInput.name = 'sectionRadio';
                radioInput.id = `section-${section.id}`;
                radioInput.value = section.id;
                
                const radioLabel = document.createElement('label');
                radioLabel.className = 'form-check-label';
                radioLabel.htmlFor = `section-${section.id}`;
                radioLabel.textContent = `${section.name} (Roll: ${section.prefix}${section.start}-${section.prefix}${section.end})`;
                
                radioDiv.appendChild(radioInput);
                radioDiv.appendChild(radioLabel);
                radioContainer.appendChild(radioDiv);
                
                // Add event listener to each radio button
                radioInput.addEventListener('change', function() {
                    if (this.checked) {
                        handleSectionChange(this.value);
                    }
                });
            });
            
            // Also populate the manual section select dropdown
            const manualSelect = document.getElementById('manualSectionSelect');
            if (manualSelect) {
                manualSelect.innerHTML = '<option value="">Choose a section...</option>';
                
                sectionsArray.forEach(section => {
                    const option = document.createElement('option');
                    option.value = section.id;
                    option.textContent = `${section.name} (Roll: ${section.prefix}${section.start}-${section.prefix}${section.end})`;
                    manualSelect.appendChild(option);
                });
            }
            
            // Set a default section if none is selected
            if (sectionsArray.length > 0 && !currentSection) {
                const defaultSection = sectionsArray[0].id;
                currentSection = defaultSection;
                
                // Check the first radio button
                const firstRadio = document.getElementById(`section-${defaultSection}`);
                if (firstRadio) {
                    firstRadio.checked = true;
                    handleSectionChange(defaultSection);
                }
                
                const selectedSection = sectionsArray.find(s => s.id === currentSection);
                if (selectedSection) {
                    document.getElementById('totalStudents').textContent = selectedSection.total_students;
                }
                loadAttendanceData();
                
                // Set the manual section select to match the current section
                if (manualSelect) {
                    manualSelect.value = currentSection;
                    // Initialize the student dropdown for this section
                    populateManualStudentSelect(selectedSection);
                }
            }
        }
        
        // Function to handle section change from radio buttons
        function handleSectionChange(sectionId) {
            if (!sectionId) return;
            
            currentSection = sectionId;
            
            // SECTIONS is already an array, so we can use it directly
            const sectionsArray = SECTIONS;
            
            const selectedSection = sectionsArray.find(s => s.id === sectionId);
            if (selectedSection) {
                // Update total students count
                document.getElementById('totalStudents').textContent = selectedSection.total_students;
                
                // Update manual section select to match
                const manualSelect = document.getElementById('manualSectionSelect');
                if (manualSelect) {
                    manualSelect.value = sectionId;
                    // Also update the student dropdown
                    populateManualStudentSelect(selectedSection);
                }
                
                // Load attendance data for the selected section
                loadAttendanceData();
            }
        }
        
        function setupEventListeners() {
            // SECTIONS is already an array, so we can use it directly
            const sectionsArray = SECTIONS;
            
            // Section selection is now handled by radio button event listeners in loadSections()
            
            // Manual section selection
            const manualSectionSelect = document.getElementById('manualSectionSelect');
            if (manualSectionSelect) {
                manualSectionSelect.addEventListener('change', function() {
                    const sectionId = this.value;
                    if (sectionId) {
                        // Populate student dropdown based on selected section
                        const selectedSection = sectionsArray.find(s => s.id === sectionId);
                        if (selectedSection) {
                            populateManualStudentSelect(selectedSection);
                        }
                    }
                });
            }
            
            // Start session
            document.getElementById('startSession').addEventListener('click', function() {
                if (!currentSection) {
                    alert('Please select a section first');
                    return;
                }
                
                fetch('/api/start_attendance', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ section: currentSection })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('Attendance session started!');
                        document.getElementById('startSession').disabled = true;
                        document.getElementById('stopSession').disabled = false;
                        document.getElementById('resetData').disabled = true;
                        document.getElementById('cameraSection').style.display = 'block';
                        
                        // Start polling for recognition status
                        startRecognitionPolling();
                        startStatsPolling();
                    } else {
                        alert('Error: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Error starting session:', error);
                    alert('Error starting session. Check console for details.');
                });
            });
            
            // Stop session
            document.getElementById('stopSession').addEventListener('click', function() {
                fetch('/api/stop_attendance', {
                    method: 'POST'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('Attendance session stopped!');
                        document.getElementById('startSession').disabled = false;
                        document.getElementById('stopSession').disabled = true;
                        document.getElementById('resetData').disabled = false;
                        
                        // Stop polling
                        stopRecognitionPolling();
                        stopStatsPolling();
                        
                        // Load attendance data
                        loadAttendanceData();
                    }
                })
                .catch(error => {
                    console.error('Error stopping session:', error);
                    alert('Error stopping session. Check console for details.');
                });
            });
            
            // Reset data
            document.getElementById('resetData').addEventListener('click', function() {
                if (confirm('Are you sure you want to reset all attendance data?')) {
                    fetch('/api/reset_attendance', {
                        method: 'POST'
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            alert('Attendance data reset!');
                            loadAttendanceData();
                        }
                    })
                    .catch(error => {
                        console.error('Error resetting data:', error);
                        alert('Error resetting data. Check console for details.');
                    });
                }
            });
            
            // Manual entry
            document.getElementById('addManualStudent').addEventListener('click', function() {
                const student = document.getElementById('manualStudentSelect').value;
                if (!student) {
                    alert('Please select a student');
                    return;
                }
                
                fetch('/api/add_student', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ student: student })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert(data.message);
                        // Hide modal using vanilla JS
                        const modal = bootstrap.Modal.getInstance(document.getElementById('manualEntryModal'));
                        modal.hide();
                        loadAttendanceData();
                    } else {
                        alert(data.message);
                    }
                })
                .catch(error => {
                    console.error('Error adding student:', error);
                    alert('Error adding student. Check console for details.');
                });
            });
            
            // Export buttons
            document.getElementById('exportExcel').addEventListener('click', function(e) {
                e.preventDefault();
                if (!currentSection) {
                    alert('Please select a section first');
                    return;
                }
                window.location.href = `/api/export_excel?section=${currentSection}`;
            });
            
            document.getElementById('exportCSV').addEventListener('click', function(e) {
                e.preventDefault();
                if (!currentSection) {
                    alert('Please select a section first');
                    return;
                }
                window.location.href = `/api/export_csv?section=${currentSection}`;
            });
            
            // Refresh stats
            document.getElementById('refreshStats').addEventListener('click', function() {
                checkRecognitionStatus();
            });
        }
        
        function checkSessionStatus() {
            fetch('/api/recognition_status')
                .then(response => response.json())
                .then(data => {
                    if (data.faces_detected > 0 || data.present_count > 0) {
                        // Session seems to be active
                        document.getElementById('startSession').disabled = true;
                        document.getElementById('stopSession').disabled = false;
                        document.getElementById('resetData').disabled = true;
                        document.getElementById('cameraSection').style.display = 'block';
                        document.getElementById('attendanceSummary').style.display = 'block';
                        
                        startRecognitionPolling();
                        startStatsPolling();
                        loadAttendanceData();
                    }
                })
                .catch(error => {
                    console.error('Error checking session status:', error);
                });
        }
        
        function startRecognitionPolling() {
            recognitionInterval = setInterval(checkRecognitionStatus, 1000);
        }
        
        function stopRecognitionPolling() {
            clearInterval(recognitionInterval);
        }
        
        function startStatsPolling() {
            statsInterval = setInterval(updateSidebarStats, 2000);
        }
        
        function stopStatsPolling() {
            clearInterval(statsInterval);
        }
        
        function checkRecognitionStatus() {
            fetch('/api/recognition_status')
                .then(response => response.json())
                .then(data => {
                    updateRecognitionUI(data);
                })
                .catch(error => {
                    console.error('Error checking recognition status:', error);
                });
        }
        
        function updateSidebarStats() {
            fetch('/api/recognition_status')
                .then(response => response.json())
                .then(data => {
                    document.getElementById('presentCount').textContent = data.present_count;
                    document.getElementById('cameraFps').textContent = data.fps.toFixed(1);
                    document.getElementById('facesDetected').textContent = data.faces_detected;
                })
                .catch(error => {
                    console.error('Error updating sidebar stats:', error);
                });
        }
        
        function updateRecognitionUI(data) {
            // Update metrics
            document.getElementById('liveFps').textContent = data.fps.toFixed(1);
            document.getElementById('liveFaces').textContent = data.faces_detected;
            document.getElementById('livePresent').textContent = data.present_count;
            
            // Update recognition results
            const resultsContainer = document.getElementById('recognitionResults');
            resultsContainer.innerHTML = '';
            
            if (data.recognition_results.length === 0) {
                resultsContainer.innerHTML = '<div class="alert alert-info">📷 Scanning for faces...</div>';
            } else {
                data.recognition_results.forEach(face => {
                    if (face.name !== "Unknown" && face.confidence > 0.4) {
                        resultsContainer.innerHTML += `
                            <div class="recognition-info">
                                <h5>✅ RECOGNIZED</h5>
                                <p><strong>${face.name}</strong></p>
                                <p>Confidence: ${(face.confidence * 100).toFixed(1)}%</p>
                            </div>
                        `;
                    } else if (face.name === "Unknown") {
                        resultsContainer.innerHTML += `
                            <div class="unknown-info">
                                <h5>❓ UNKNOWN</h5>
                                <p>Face detected</p>
                                <p>Not in database</p>
                            </div>
                        `;
                    }
                });
            }
            
            // Update recent recognitions with photos
            const recentContainer = document.getElementById('recentRecognitions');
            recentContainer.innerHTML = '';
            
            if (data.present_students.length === 0) {
                recentContainer.innerHTML = '<p class="text-muted text-center">No recognitions yet</p>';
            } else {
                data.present_students.forEach(student => {
                    const photoHtml = createStudentPhotoElement(student, `Student ${student}`, 30);
                    recentContainer.innerHTML += `
                        <div class="alert alert-success d-flex align-items-center" style="padding: 0.5rem;">
                            <div style="margin-right: 10px;">${photoHtml}</div>
                            <div>✅ ${student}</div>
                        </div>
                    `;
                });
            }
        }
        
        function loadAttendanceData() {
            if (!currentSection) return;
            
            fetch(`/api/attendance_data?section=${currentSection}`)
                .then(response => response.json())
                .then(data => {
                    // Update summary
                    document.getElementById('attendanceRatio').textContent = `${data.summary.present}/${data.summary.total}`;
                    document.getElementById('attendanceRate').textContent = `${data.summary.rate}%`;
                    
                    // Update present students list with photos
                    const presentList = document.getElementById('presentStudentsList');
                    presentList.innerHTML = '';
                    
                    const presentStudents = data.data.filter(item => item.status === 'Present');
                    if (presentStudents.length === 0) {
                        presentList.innerHTML = '<p class="text-muted text-center">No students marked present yet</p>';
                    } else {
                        presentStudents.forEach(item => {
                            const photoHtml = createStudentPhotoElement(item.roll_number, item.student_name, 35);
                            presentList.innerHTML += `
                                <div class="d-flex align-items-center mb-2" style="padding: 0.5rem; background: rgba(40, 167, 69, 0.1); border-radius: 8px;">
                                    <div style="margin-right: 10px;">${photoHtml}</div>
                                    <div>
                                        <strong>${item.roll_number}</strong><br>
                                        <small class="text-muted">${item.student_name}</small>
                                    </div>
                                </div>
                            `;
                        });
                    }
                    
                    // Update table with enhanced student details
                    const tableBody = document.querySelector('#attendanceTable tbody');
                    tableBody.innerHTML = '';
                    
                    data.data.forEach(item => {
                        const row = document.createElement('tr');
                        const photoHtml = createStudentPhotoElement(item.roll_number, item.student_name);
                        
                        row.innerHTML = `
                            <td>${item.sno}</td>
                            <td>
                                <div class="student-info-cell">
                                    <div>${photoHtml}</div>
                                    <div class="student-details">
                                        <p class="student-name">${item.student_name}</p>
                                        <p class="student-mobile">📱 ${item.mobile}</p>
                                        <p class="student-sgpa">📊 SGPA: Available</p>
                                    </div>
                                </div>
                            </td>
                            <td><strong>${item.roll_number}</strong></td>
                            <td class="${item.status === 'Present' ? 'text-success fw-bold' : 'text-danger fw-bold'}">
                                ${item.status === 'Present' ? 'Present ✅' : 'Absent ❌'}
                            </td>
                            <td>${item.section}</td>
                            <td>
                            <button class="btn btn-sm btn-outline-primary" onclick="showStudentDetails('${item.roll_number}')">
                                👤 Profile
                            </button>
                        </td>
                        `;
                        tableBody.appendChild(row);
                    });
                    
                    // No chart update needed
                    
                    // Show attendance summary
                    document.getElementById('attendanceSummary').style.display = 'block';
                    
                    // Populate manual student select with student names
                    const manualSelect = document.getElementById('manualStudentSelect');
                    manualSelect.innerHTML = '<option value="">Select a student...</option>';
                    
                    data.data.forEach(item => {
                        const option = document.createElement('option');
                        option.value = item.roll_number;
                        option.textContent = `${item.roll_number} - ${item.student_name}`;
                        manualSelect.appendChild(option);
                    });
                    
                    // Populate the attendance marking table
                    populateAttendanceMarkingTable(data);
                })
                .catch(error => {
                    console.error('Error loading attendance data:', error);
                });
        }
        
        // Chart function removed
    </script>
    <!-- Student Graph Modal Removed -->
    
    <script>
        // Student Graph Functions Removed
            
        // Chart and color functions removed

        // Populate Manual Student Select dropdown based on section
        function populateManualStudentSelect(section) {
            const manualStudentSelect = document.getElementById('manualStudentSelect');
            if (!manualStudentSelect) return;
            
            manualStudentSelect.innerHTML = '<option value="">Select a student...</option>';
            
            // Generate roll numbers based on section start and end
            for (let i = section.start; i <= section.end; i++) {
                const rollNumber = `${section.prefix}${String(i).padStart(2, '0')}`;
                const option = document.createElement('option');
                option.value = rollNumber;
                option.textContent = rollNumber;
                manualStudentSelect.appendChild(option);
            }
        }
        
        // Populate Attendance Marking Table
        function populateAttendanceMarkingTable(data) {
            const tableBody = document.querySelector('#attendanceMarkingTable tbody');
            tableBody.innerHTML = '';
            
            data.data.forEach(item => {
                const row = document.createElement('tr');
                const isPresent = item.status === 'Present';
                
                row.innerHTML = `
                    <td>${item.roll_number}</td>
                    <td>${item.student_name}</td>
                    <td>
                        <div class="form-check form-switch">
                            <input class="form-check-input attendance-toggle" type="checkbox" 
                                   id="status-${item.roll_number}" ${isPresent ? 'checked' : ''}
                                   data-roll="${item.roll_number}">
                            <label class="form-check-label" for="status-${item.roll_number}">
                                <span class="${isPresent ? 'text-success' : 'text-danger'}">
                                    ${isPresent ? 'Present (1)' : 'Absent (0)'}
                                </span>
                            </label>
                        </div>
                    </td>
                    <td>
                        <button class="btn btn-sm ${isPresent ? 'btn-danger' : 'btn-success'} toggle-btn"
                                data-roll="${item.roll_number}" data-action="${isPresent ? 'absent' : 'present'}">
                            ${isPresent ? 'Mark Absent' : 'Mark Present'}
                        </button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
            
            // Add event listeners for toggle buttons
            document.querySelectorAll('.toggle-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const rollNumber = this.getAttribute('data-roll');
                    const action = this.getAttribute('data-action');
                    const newStatus = action === 'present' ? 'Present' : 'Absent';
                    
                    updateStudentAttendance(rollNumber, newStatus);
                });
            });
            
            // Add event listeners for checkbox toggles
            document.querySelectorAll('.attendance-toggle').forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    const rollNumber = this.getAttribute('data-roll');
                    const newStatus = this.checked ? 'Present' : 'Absent';
                    
                    updateStudentAttendance(rollNumber, newStatus);
                });
            });
            
            // Add event listeners for mark all buttons
            document.getElementById('markAllPresent').addEventListener('click', function() {
                if (confirm('Are you sure you want to mark all students as present?')) {
                    markAllStudents('Present');
                }
            });
            
            document.getElementById('markAllAbsent').addEventListener('click', function() {
                if (confirm('Are you sure you want to mark all students as absent?')) {
                    markAllStudents('Absent');
                }
            });
            
            // Add event listener for save attendance button
            document.getElementById('saveAttendance').addEventListener('click', function() {
                saveManualAttendance();
            });
        }
        
        // Update student attendance status
        function updateStudentAttendance(rollNumber, status) {
            // Update UI first for responsiveness
            const checkbox = document.getElementById(`status-${rollNumber}`);
            const label = checkbox.nextElementSibling;
            const toggleBtn = document.querySelector(`.toggle-btn[data-roll="${rollNumber}"]`);
            
            checkbox.checked = status === 'Present';
            label.innerHTML = `<span class="${status === 'Present' ? 'text-success' : 'text-danger'}">
                ${status === 'Present' ? 'Present (1)' : 'Absent (0)'}
            </span>`;
            
            toggleBtn.className = `btn btn-sm ${status === 'Present' ? 'btn-danger' : 'btn-success'} toggle-btn`;
            toggleBtn.textContent = status === 'Present' ? 'Mark Absent' : 'Mark Present';
            toggleBtn.setAttribute('data-action', status === 'Present' ? 'absent' : 'present');
        }
        
        // Mark all students with the same status
        function markAllStudents(status) {
            document.querySelectorAll('.attendance-toggle').forEach(checkbox => {
                const rollNumber = checkbox.getAttribute('data-roll');
                updateStudentAttendance(rollNumber, status);
            });
        }
        
        // Save manual attendance
        function saveManualAttendance() {
            if (!currentSection) {
                alert('Please select a section first');
                return;
            }
            
            const attendanceData = [];
            document.querySelectorAll('.attendance-toggle').forEach(checkbox => {
                attendanceData.push({
                    roll_number: checkbox.getAttribute('data-roll'),
                    status: checkbox.checked ? 'Present' : 'Absent'
                });
            });
            
            fetch('/api/save_manual_attendance', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    section: currentSection,
                    attendance: attendanceData
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Attendance saved successfully!');
                    loadAttendanceData();
                } else {
                    alert('Error: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error saving attendance:', error);
                alert('Error saving attendance. Check console for details.');
            });
        }
        
        // Teacher Profile Functions have been removed as they are no longer needed
                                                <h3>${stats.total_students}</h3>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="metric-card">
                                                <h6>Total Classes</h6>
                                                <h3>${stats.total_classes || 0}</h3>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="metric-card">
                                                <h6>Avg. Attendance</h6>
                                                <div class="progress mt-2" style="height: 20px;">
                                                    <div class="progress-bar ${stats.avg_attendance_rate >= 75 ? 'bg-success' : 'bg-warning'}" 
                                                         role="progressbar" style="width: ${stats.avg_attendance_rate}%;"
                                                         aria-valuenow="${stats.avg_attendance_rate}" aria-valuemin="0" aria-valuemax="100">
                                                        ${stats.avg_attendance_rate}%
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    ${stats.daily_attendance && stats.daily_attendance.length > 0 ? `
                                    <div class="mt-4 mb-4">
                                        <h6 class="mb-3">Attendance Trend</h6>
                                        <canvas id="${chartId}" width="400" height="200"></canvas>
                                    </div>` : ''}
                                    
                                    <div class="mt-3">
                                        <h6 class="mb-3">Daily Attendance</h6>
                                        <div class="table-responsive">
                                            <table class="table table-hover">
                                                <thead>
                                                    <tr>
                                                        <th>Date</th>
                                                        <th>Present</th>
                                                        <th>Absent</th>
                                                        <th>Rate</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    ${stats.daily_attendance && stats.daily_attendance.length > 0 ? stats.daily_attendance.map(day => `
                                                        <tr>
                                                            <td>${day.date}</td>
                                                            <td class="text-success">${day.present}</td>
                                                            <td class="text-danger">${day.absent}</td>
                                                            <td>
                                                                <div class="progress" style="height: 20px;">
                                                                    <div class="progress-bar ${day.rate >= 75 ? 'bg-success' : 'bg-warning'}" 
                                                                         role="progressbar" style="width: ${day.rate}%;"
                                                                         aria-valuenow="${day.rate}" aria-valuemin="0" aria-valuemax="100">
                                                                        ${day.rate}%
                                                                    </div>
                                                                </div>
                                                            </td>
                                                        </tr>
                                                    `).join('') : `<tr><td colspan="4" class="text-center">No attendance data available</td></tr>`}
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                        sectionStatsAccordion.appendChild(accordionItem);
                        
                        // Create chart if there's attendance data
                        if (stats.daily_attendance && stats.daily_attendance.length > 0) {
                            // Use setTimeout to ensure the canvas is in the DOM
                            setTimeout(() => {
                                const canvas = document.getElementById(chartId);
                                if (canvas) {
                                    const ctx = canvas.getContext('2d');
                                    const chartLabels = stats.daily_attendance.map(day => day.date).slice(-7).reverse();
                                    const chartData = stats.daily_attendance.map(day => day.rate).slice(-7).reverse();
                                    
                                    new Chart(ctx, {
                                        type: 'line',
                                        data: {
                                            labels: chartLabels,
                                            datasets: [{
                                                label: 'Attendance Rate (%)',
                                                data: chartData,
                                                backgroundColor: 'rgba(75, 192, 192, 0.2)',
                                                borderColor: 'rgba(75, 192, 192, 1)',
                                                borderWidth: 2,
                                                tension: 0.1,
                                                fill: true
                                            }]
                                        },
                                        options: {
                                            responsive: true,
                                            scales: {
                                                y: {
                                                    beginAtZero: true,
                                                    max: 100,
                                                    title: {
                                                        display: true,
                                                        text: 'Attendance Rate (%)'
                                                    }
                                                },
                                                x: {
                                                    title: {
                                                        display: true,
                                                        text: 'Date'
                                                    }
                                                }
                                            },
                                            plugins: {
                                                tooltip: {
                                                    callbacks: {
                                                        label: function(context) {
                                                            return `Attendance: ${context.parsed.y}%`;
                                                        }
                                                    }
                                                }
                                            }
                                        }
                                    });
                                }
                            }, 100);
                        }
                    });
                })
                .catch(error => {
                    console.error('Error loading teacher profile:', error);
                });
        }
    </script>
</body>
</html>